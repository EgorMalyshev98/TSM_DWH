
{{
    config(
        tags=['stage', 'жуфвр_1с']
    )
}}

SELECT
    recsource,
    loadts,
    hkcode,
    hk_dv_hub_fact_journal,
	bk_жуфвр_uuid,
	hdiff_dv_sat_fact_journal,
	проведен,
	uuid_жуфвр,
	пометка_удаления,
	дата,
	номер,
	территория_value,
	территория_codе,
	территория_name,
	подразделение_value,
	подразделение_codе,
	подразделение_name,
	смена_value,
	смена_codе,
	смена_name,
	прораб_value,
	прораб_codе,
	прораб_name,
	комментарий,
	ответственный_value,
	ответственный_codе,
	ответственный_name,
	версия_жуфвр_value,
	версия_жуфвр_codе,
	версия_жуфвр_name,
	направление_деятельности_value,
	направление_деятельности_codе,
	направление_деятельности_name
FROM (
    SELECT
        recsource,
        loadts,
        'default',
        digest('default' || '|' || LOWER(TRIM(COALESCE("value_Ссылка"::varchar, '-1')::varchar)), 'sha1') as hk_dv_hub_fact_journal,
	LOWER(TRIM(COALESCE("value_Ссылка"::varchar, '-1')::varchar)),
	digest(TRIM(COALESCE("value_Проведен"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Ссылка"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_ПометкаУдаления"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Дата"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Номер"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Территория_value"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Территория_codе"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Территория_name"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Подразделение_value"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Подразделение_codе"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Подразделение_name"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Смена_value"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Смена_codе"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Смена_name"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Прораб_value"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Прораб_codе"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Прораб_name"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Комментарий"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Ответственный_value"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Ответственный_codе"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_Ответственный_name"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_АктуальнаяВерсияЖУФВР_value"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_АктуальнаяВерсияЖУФВР_codе"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_АктуальнаяВерсияЖУФВР_name"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_НаправлениеДеятельности_value"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_НаправлениеДеятельности_codе"::varchar, 'N\A')) || '|' || TRIM(COALESCE("value_НаправлениеДеятельности_name"::varchar, 'N\A')), 'sha1') as hdiff_dv_sat_fact_journal,
	"value_Проведен"::boolean,
	"value_Ссылка"::uuid,
	"value_ПометкаУдаления"::boolean,
	"value_Дата"::timestamptz,
	"value_Номер"::varchar,
	"value_Территория_value"::uuid,
	"value_Территория_codе"::varchar,
	"value_Территория_name"::varchar,
	"value_Подразделение_value"::uuid,
	"value_Подразделение_codе"::varchar,
	"value_Подразделение_name"::varchar,
	"value_Смена_value"::uuid,
	"value_Смена_codе"::varchar,
	"value_Смена_name"::varchar,
	"value_Прораб_value"::uuid,
	"value_Прораб_codе"::varchar,
	"value_Прораб_name"::varchar,
	"value_Комментарий"::varchar,
	"value_Ответственный_value"::uuid,
	"value_Ответственный_codе"::varchar,
	"value_Ответственный_name"::varchar,
	"value_АктуальнаяВерсияЖУФВР_value"::uuid,
	"value_АктуальнаяВерсияЖУФВР_codе"::varchar,
	"value_АктуальнаяВерсияЖУФВР_name"::varchar,
	"value_НаправлениеДеятельности_value"::uuid,
	"value_НаправлениеДеятельности_codе"::varchar,
	"value_НаправлениеДеятельности_name"::varchar
    FROM 
        {{ source('public', 'src_journal') }}
) AS tmp (recsource, loadts, hkcode, hk_dv_hub_fact_journal,
	bk_жуфвр_uuid,
	hdiff_dv_sat_fact_journal,
	проведен,
	uuid_жуфвр,
	пометка_удаления,
	дата,
	номер,
	территория_value,
	территория_codе,
	территория_name,
	подразделение_value,
	подразделение_codе,
	подразделение_name,
	смена_value,
	смена_codе,
	смена_name,
	прораб_value,
	прораб_codе,
	прораб_name,
	комментарий,
	ответственный_value,
	ответственный_codе,
	ответственный_name,
	версия_жуфвр_value,
	версия_жуфвр_codе,
	версия_жуфвр_name,
	направление_деятельности_value,
	направление_деятельности_codе,
	направление_деятельности_name)
